var k=Object.defineProperty;var e=(n,t)=>k(n,"name",{value:t,configurable:!0});const P=e(n=>new Promise(t=>{setTimeout(t,n,`Timeout after ${n/1e3} seconds`)}),"waitFor");var h;(function(n){n.DEV="DEV",n.UAT="UAT",n.PRD="PRD"})(h||(h={}));var S;(function(n){n.GITHUB="GitHub",n.GITLAB="GitLab",n.BITBUCKET="Bitbucket",n.LOCALHOST="localhost",n.UNKNOWN="unknown"})(S||(S={}));var I=globalThis&&globalThis.__awaiter||function(n,t,o,i){function p(s){return s instanceof o?s:new o(function(l){l(s)})}return e(p,"adopt"),new(o||(o=Promise))(function(s,l){function _(a){try{d(i.next(a))}catch(u){l(u)}}e(_,"fulfilled");function y(a){try{d(i.throw(a))}catch(u){l(u)}}e(y,"rejected");function d(a){a.done?s(a.value):p(a.value).then(_,y)}e(d,"step"),d((i=i.apply(n,t||[])).next())})};let T,L,N,C,G;const R=e(()=>{T=!1,L="rmg-unknown",N="unknown",C=h.PRD,G=S.UNKNOWN},"_resetConfig"),j=e(()=>I(void 0,void 0,void 0,function*(){const n=window.location.pathname.split("/")[1],t=n?`/${n}/info.json`:"/info.json",o=yield fetch(t);if(o.ok){const i=yield o.json();L=i.component,N=i.version,C=i.environment,G=i.instance}else throw new Error(`Failed to fetch config from ${t}`)}),"fetchInfoJson"),H=e(()=>I(void 0,void 0,void 0,function*(){try{console.log("[rmg-runtime] Loading config...");const n=yield Promise.race([j(),P(10*1e3)]);n?console.error("[rmg-runtime] Failed to load config.",n):(T=!0,console.log("[rmg-runtime] Config loaded!"))}catch(n){console.error("[rmg-runtime] Failed to load config.",n)}}),"loadWithTimeout"),V=e(()=>T,"isInitialised"),$=e(()=>L,"getComponent"),x=e(()=>N,"getVersion"),Q=e(()=>C,"getEnvironment"),B=e(()=>G,"getInstance");R();const r={loadWithTimeout:H,isInitialised:V,getComponent:$,getVersion:x,getEnvironment:Q,getInstance:B,_resetConfig:R};window.dataLayer=window.dataLayer||[];const K=e(()=>{const n=document.createElement("script");n.async=!0,n.src="https://www.googletagmanager.com/gtag/js?id=G-2HP8Y4MRRQ",document.head.append(n)},"installGtag");function U(...n){if(r.getEnvironment()!==h.DEV)return window.dataLayer.push(arguments);console.log("[rmg-runtime] Not going to send event in DEV environment",n)}e(U,"gtag");const Y=e((n,t)=>{U("event",n,t)},"customEvent"),q=e(()=>{K(),U("js",new Date),U("config","G-2HP8Y4MRRQ",{appName:r.getComponent(),version:r.getVersion(),environment:r.getEnvironment(),instance:r.getInstance()})},"init$1"),v={init:q,customEvent:Y},z="rmg-runtime-channel",A={};let f;try{f=new BroadcastChannel(z),f.onmessage=n=>{var t;const{event:o,data:i,frameId:p}=n.data;(t=A[o])===null||t===void 0||t.forEach(s=>s(i,p))}}catch(n){console.warn("[rmg-runtime] Failed to initiate broadcast channel. Some features may be unavailable.",n)}const J=e((n,t)=>{var o;f==null||f.postMessage({event:n,data:t,frameId:(o=window.frameElement)===null||o===void 0?void 0:o.id})},"postEvent"),X=e((n,t)=>{var o;n in A?(o=A[n])===null||o===void 0||o.push(t):A[n]=[t]},"onMessage"),w={postEvent:J,onMessage:X};var g;(function(n){n.SET_LANGUAGE="SET_LANGUAGE",n.OPEN_APP="OPEN_APP",n.UPDATE_URL="UPDATE_URL"})(g||(g={}));const D=e(()=>!window.frameElement,"isStandaloneWindow"),Z=e(()=>{if(!D()){const n=document.createElement("style");n.textContent=".rmg-window__header{display: none !important;}",document.head.append(n)}},"injectCss"),nn=e(n=>{w.postEvent(g.OPEN_APP,n)},"openApp"),en=e(n=>{w.postEvent(g.UPDATE_URL,n)},"updateUrl"),tn=e(n=>{w.onMessage(g.OPEN_APP,n)},"onAppOpen"),on=e(n=>{w.onMessage(g.UPDATE_URL,n)},"onUrlUpdate"),m={isStandaloneWindow:D,injectCss:Z,openApp:nn,onAppOpen:tn,updateUrl:en,onUrlUpdate:on},b="rmg-runtime__language",E="rmg-runtime__allowAnalytics",M=["en","zh-Hans","zh-Hant"],an=e(n=>{M.includes(n)&&(w.postEvent(g.SET_LANGUAGE,n),window.localStorage.setItem(b,n))},"setLanguage"),sn=e(()=>{const n=window.localStorage.getItem(b);return n&&M.includes(n)?n:"en"},"getLanguage"),rn=e(n=>{w.onMessage(g.SET_LANGUAGE,n)},"onLanguageChange"),ln=e(()=>window.localStorage.getItem(E)!==null,"isAnalyticsQADone"),O=e(()=>window.localStorage.getItem(E)==="true","isAllowAnalytics"),cn=e(n=>{const t=O();return n?(t||(window.localStorage.setItem(E,n.toString()),v.init()),{refreshRequired:!1}):t?(window.localStorage.setItem(E,n.toString()),{refreshRequired:!0}):{refreshRequired:!1}},"allowAnalytics"),c={setLanguage:an,getLanguage:sn,onLanguageChange:rn,isAnalyticsQADone:ln,isAllowAnalytics:O,allowAnalytics:cn},gn=new Date().getTime();function dn(){const n=r.getComponent(),t=window.localStorage.getItem(n+"__startTime");return t===null?new Date().getTime()-gn:new Date().getTime()-Number(t)}e(dn,"getMsSinceStartUp");const un={getMsSinceStartUp:dn},mn=e(()=>{let n=r.getComponent();if(n==="rmg-unknown"){console.log("[rmg-runtime] Unable to clear storage for unknown app");return}n==="railmapgen.github.io"&&(n="rmg-home");let t=0;for(;t<window.localStorage.length;){const o=window.localStorage.key(t);o!=null&&o.startsWith(n+"__")?(window.localStorage.removeItem(o),console.log(`[rmg-runtime] Removed item ${o}`)):t++}},"clearStorageForCurrentApp"),wn={clearStorageForCurrentApp:mn};var F=globalThis&&globalThis.__awaiter||function(n,t,o,i){function p(s){return s instanceof o?s:new o(function(l){l(s)})}return e(p,"adopt"),new(o||(o=Promise))(function(s,l){function _(a){try{d(i.next(a))}catch(u){l(u)}}e(_,"fulfilled");function y(a){try{d(i.throw(a))}catch(u){l(u)}}e(y,"rejected");function d(a){a.done?s(a.value):p(a.value).then(_,y)}e(d,"step"),d((i=i.apply(n,t||[])).next())})};let W=!1;const pn=e(()=>F(void 0,void 0,void 0,function*(){yield r.loadWithTimeout(),c.isAnalyticsQADone()?c.isAllowAnalytics()&&(console.log("[rmg-runtime] User has previously allowed GA"),v.init()):m.isStandaloneWindow()&&r.getComponent()!=="rmg-home"&&(console.warn("[rmg-runtime] App is opened in standalone window but analytics Q&A is not finished. GA will be init by default."),v.init()),W=!0}),"init"),fn=e(()=>F(void 0,void 0,void 0,function*(){let n=0;for(;n<=10&&!W;)yield P(1e3),n+=1}),"ready"),An={ready:fn,getAppName:r.getComponent,getAppVersion:r.getVersion,getEnv:r.getEnvironment,getInstance:r.getInstance,event:v.customEvent,isStandaloneWindow:m.isStandaloneWindow,injectCss:m.injectCss,openApp:m.openApp,onAppOpen:m.onAppOpen,updateUrl:m.updateUrl,onUrlUpdate:m.onUrlUpdate,setLanguage:c.setLanguage,getLanguage:c.getLanguage,onLanguageChange:c.onLanguageChange,isAnalyticsQADone:c.isAnalyticsQADone,isAllowAnalytics:c.isAllowAnalytics,allowAnalytics:c.allowAnalytics,clearStorageForCurrentApp:wn.clearStorageForCurrentApp,getMsSinceStartUp:un.getMsSinceStartUp};pn().then();window.rmgRuntime=An;export{h as R,An as r};
//# sourceMappingURL=index.04f2df3b.js.map

var R=Object.defineProperty;var e=(n,t)=>R(n,"name",{value:t,configurable:!0});const b=e(n=>new Promise(t=>{setTimeout(t,n,`Timeout after ${n/1e3} seconds`)}),"waitFor");var v;(function(n){n.DEV="DEV",n.UAT="UAT",n.PRD="PRD"})(v||(v={}));var A;(function(n){n.GITHUB="GitHub",n.GITLAB="GitLab",n.BITBUCKET="Bitbucket",n.LOCALHOST="localhost",n.UNKNOWN="unknown"})(A||(A={}));var C=globalThis&&globalThis.__awaiter||function(n,t,o,a){function p(r){return r instanceof o?r:new o(function(c){c(r)})}return e(p,"adopt"),new(o||(o=Promise))(function(r,c){function h(i){try{g(a.next(i))}catch(u){c(u)}}e(h,"fulfilled");function E(i){try{g(a.throw(i))}catch(u){c(u)}}e(E,"rejected");function g(i){i.done?r(i.value):p(i.value).then(h,E)}e(g,"step"),g((a=a.apply(n,t||[])).next())})};let L,S,T,N,y;const P=e(()=>{L=!1,S="rmg-unknown",T="unknown",N=v.PRD,y=A.UNKNOWN},"_resetConfig"),I=e(()=>C(void 0,void 0,void 0,function*(){const n=window.location.pathname.split("/")[1],t=n?`/${n}/info.json`:"/info.json",o=yield fetch(t);if(o.ok){const a=yield o.json();S=a.component,T=a.version,N=a.environment,y=a.instance}else throw new Error(`Failed to fetch config from ${t}`)}),"fetchInfoJson"),F=e(()=>C(void 0,void 0,void 0,function*(){try{console.log("[rmg-runtime] Loading config...");const n=yield Promise.race([I(),b(10*1e3)]);n?console.error("[rmg-runtime] Failed to load config.",n):(L=!0,console.log("[rmg-runtime] Config loaded!"))}catch(n){console.error("[rmg-runtime] Failed to load config.",n)}}),"waitForSettled"),O=e(()=>L,"isInitialised"),k=e(()=>S,"getComponent"),j=e(()=>T,"getVersion"),H=e(()=>N,"getEnvironment"),V=e(()=>y,"getInstance");P();const s={waitForSettled:F,isInitialised:O,getComponent:k,getVersion:j,getEnvironment:H,getInstance:V,_resetConfig:P};window.dataLayer=window.dataLayer||[];const x=e(()=>{const n=document.createElement("script");n.async=!0,n.src="https://www.googletagmanager.com/gtag/js?id=G-2HP8Y4MRRQ",document.head.append(n)},"installGtag");function U(...n){if(s.getEnvironment()!==v.DEV)return window.dataLayer.push(arguments);console.log("[rmg-runtime] Not going to send event in DEV environment",n)}e(U,"gtag");const B=e((n,t)=>{U("event",n,t)},"customEvent"),W=e(()=>{x(),U("js",new Date),U("config","G-2HP8Y4MRRQ",{appName:s.getComponent(),version:s.getVersion(),environment:s.getEnvironment(),instance:s.getInstance()})},"initLogger");s.waitForSettled().then(()=>{W()});const $={customEvent:B},K="rmg-runtime-channel",w={};let f;try{f=new BroadcastChannel(K),f.onmessage=n=>{var t;const{event:o,data:a,frameId:p}=n.data;(t=w[o])===null||t===void 0||t.forEach(r=>r(a,p))}}catch(n){console.warn("[rmg-runtime] Failed to initiate broadcast channel. Some features may be unavailable.",n)}const Y=e((n,t)=>{var o;f==null||f.postMessage({event:n,data:t,frameId:(o=window.frameElement)===null||o===void 0?void 0:o.id})},"postEvent"),z=e((n,t)=>{var o;n in w?(o=w[n])===null||o===void 0||o.push(t):w[n]=[t]},"onMessage"),m={postEvent:Y,onMessage:z};var l;(function(n){n.SET_LANGUAGE="SET_LANGUAGE",n.OPEN_APP="OPEN_APP",n.UPDATE_URL="UPDATE_URL"})(l||(l={}));const G=e(()=>!window.frameElement,"isStandaloneWindow"),Q=e(()=>{if(!G()){const n=document.createElement("style");n.textContent=".rmg-window__header{display: none !important;}",document.head.append(n)}},"injectCss"),J=e(n=>{m.postEvent(l.OPEN_APP,n)},"openApp"),q=e(n=>{m.postEvent(l.UPDATE_URL,n)},"updateUrl"),X=e(n=>{m.onMessage(l.OPEN_APP,n)},"onAppOpen"),Z=e(n=>{m.onMessage(l.UPDATE_URL,n)},"onUrlUpdate"),d={isStandaloneWindow:G,injectCss:Q,openApp:J,onAppOpen:X,updateUrl:q,onUrlUpdate:Z},D="rmg-runtime__language",M=["en","zh-Hans","zh-Hant"],nn=e(n=>{M.includes(n)&&(m.postEvent(l.SET_LANGUAGE,n),window.localStorage.setItem(D,n))},"setLanguage"),en=e(()=>{const n=window.localStorage.getItem(D);return n&&M.includes(n)?n:"en"},"getLanguage"),tn=e(n=>{m.onMessage(l.SET_LANGUAGE,n)},"onLanguageChange"),_={setLanguage:nn,getLanguage:en,onLanguageChange:tn},on=new Date().getTime();function an(){const n=s.getComponent(),t=window.localStorage.getItem(n+"__startTime");return t===null?new Date().getTime()-on:new Date().getTime()-Number(t)}e(an,"getMsSinceStartUp");const rn={getMsSinceStartUp:an},sn=e(()=>{let n=s.getComponent();if(n==="rmg-unknown"){console.log("[rmg-runtime] Unable to clear storage for unknown app");return}n==="railmapgen.github.io"&&(n="rmg-home");let t=0;for(;t<window.localStorage.length;){const o=window.localStorage.key(t);o!=null&&o.startsWith(n+"__")?(window.localStorage.removeItem(o),console.log(`[rmg-runtime] Removed item ${o}`)):t++}},"clearStorageForCurrentApp"),cn={clearStorageForCurrentApp:sn};var ln=globalThis&&globalThis.__awaiter||function(n,t,o,a){function p(r){return r instanceof o?r:new o(function(c){c(r)})}return e(p,"adopt"),new(o||(o=Promise))(function(r,c){function h(i){try{g(a.next(i))}catch(u){c(u)}}e(h,"fulfilled");function E(i){try{g(a.throw(i))}catch(u){c(u)}}e(E,"rejected");function g(i){i.done?r(i.value):p(i.value).then(h,E)}e(g,"step"),g((a=a.apply(n,t||[])).next())})};const gn={ready:()=>ln(void 0,void 0,void 0,function*(){yield Promise.all([s.waitForSettled()])}),getAppName:s.getComponent,getAppVersion:s.getVersion,getEnv:s.getEnvironment,getInstance:s.getInstance,event:$.customEvent,isStandaloneWindow:d.isStandaloneWindow,injectCss:d.injectCss,openApp:d.openApp,onAppOpen:d.onAppOpen,updateUrl:d.updateUrl,onUrlUpdate:d.onUrlUpdate,setLanguage:_.setLanguage,getLanguage:_.getLanguage,onLanguageChange:_.onLanguageChange,clearStorageForCurrentApp:cn.clearStorageForCurrentApp,getMsSinceStartUp:rn.getMsSinceStartUp};window.rmgRuntime=gn;export{v as R,gn as r};
//# sourceMappingURL=index.03b9dda4.js.map
